.PHONY: all setup clean i686 i686-setup i686-clean i686-define-asm-include i686-redefine-asm-include i686-compile-asm i686-recompile-asm i686-compile-c i686-link i686-relink

ANY_DIR_BUILD = build

ANY_DIR_SOURCE = src
ANY_DIR_SOURCE_ASM = ${ANY_DIR_SOURCE}/asm
ANY_DIR_SOURCE_C = ${ANY_DIR_SOURCE}/c

ANY_DIRS_INCLUDE_ASM = ${ANY_DIR_SOURCE_ASM}
ANY_DIRS_INCLUDE_C = ${ANY_DIR_SOURCE_C}

all: i686

setup:
	set -e
	mkdir -p ${ANY_DIR_BUILD}

clean:
	rm -rf ${ANY_DIR_BUILD}

I686_DIR_BUILD = ${ANY_DIR_BUILD}/i686
I686_DIR_BUILD_ASM = ${I686_DIR_BUILD}/asm
I686_DIR_BUILD_C = ${I686_DIR_BUILD}/c

I686_DIRS_INCLUDE_ASM = ${ANY_DIRS_INCLUDE_ASM} ${I686_DIR_BUILD_ASM}
I686_DIRS_INCLUDE_C = ${ANY_DIRS_INCLUDE_C}

i686: i686-setup i686-link i686-relink

i686-setup: setup i686-clean
	mkdir ${I686_DIR_BUILD}
	mkdir ${I686_DIR_BUILD_ASM}
	mkdir ${I686_DIR_BUILD_C}

i686-clean:
	rm -rf ${I686_DIR_BUILD}

I686_DEFINE_ASM_FILE_INCLUDE = ${I686_DIR_BUILD_ASM}/include.asm

i686-define-asm-include:
	printf "%%define INCLUDE_NUMBER_OF_LATE_SECTORS 0" > ${I686_DEFINE_ASM_FILE_INCLUDE}

I686_REDEFINE_ASM_FILE_INPUT = ${I686_LINK_FILE_OUTPUT}
I686_REDEFINE_ASM_FILE_INCLUDE = ${I686_DEFINE_ASM_FILE_INCLUDE}

i686-redefine-asm-include: i686-link
	printf "%%define INCLUDE_NUMBER_OF_LATE_SECTORS %s" $(shell expr $(shell expr $(shell wc -c < ${I686_REDEFINE_ASM_FILE_INPUT}) + 511) / 512) > ${I686_REDEFINE_ASM_FILE_INCLUDE}

I686_COMPILE_ASM_SOURCES_ASM = $(patsubst ${ANY_DIR_SOURCE_ASM}/%.asm, %, $(wildcard ${ANY_DIR_SOURCE_ASM}/*.asm))

I686_COMPILE_ASM_FLAGS_COMMON = -f elf32
I686_COMPILE_ASM_FLAGS_INCLUDE = $(addprefix -I , $(wordlist 1, $(words ${I686_DIRS_INCLUDE_ASM}), ${I686_DIRS_INCLUDE_ASM}))

I686_COMPILE_ASM_PATTERN_SOURCE_ASM = ${ANY_DIR_SOURCE_ASM}/${name}.asm
I686_COMPILE_ASM_PATTERN_BUILD_ASM = ${I686_DIR_BUILD_ASM}/${name}.bin

i686-compile-asm: i686-define-asm-include
	$(foreach name, ${I686_COMPILE_ASM_SOURCES_ASM}, \
	nasm ${I686_COMPILE_ASM_FLAGS_COMMON} ${I686_COMPILE_ASM_FLAGS_INCLUDE} ${I686_COMPILE_ASM_PATTERN_SOURCE_ASM} -o ${I686_COMPILE_ASM_PATTERN_BUILD_ASM};)

I686_RECOMPILE_ASM_SOURCES_ASM = ${I686_COMPILE_ASM_SOURCES_ASM}

I686_RECOMPILE_ASM_FLAGS_COMMON = ${I686_COMPILE_ASM_FLAGS_COMMON}
I686_RECOMPILE_ASM_FLAGS_INCLUDE = ${I686_COMPILE_ASM_FLAGS_INCLUDE}

I686_RECOMPILE_ASM_PATTERN_SOURCE_ASM = ${I686_COMPILE_ASM_PATTERN_SOURCE_ASM}
I686_RECOMPILE_ASM_PATTERN_BUILD_ASM = ${I686_COMPILE_ASM_PATTERN_BUILD_ASM}

i686-recompile-asm: i686-redefine-asm-include
	$(foreach name, ${I686_RECOMPILE_ASM_SOURCES_ASM}, \
	nasm ${I686_RECOMPILE_ASM_FLAGS_COMMON} ${I686_RECOMPILE_ASM_FLAGS_INCLUDE} ${I686_RECOMPILE_ASM_PATTERN_SOURCE_ASM} -o ${I686_RECOMPILE_ASM_PATTERN_BUILD_ASM};)

I686_COMPILE_C_SOURCES_C = $(patsubst ${ANY_DIR_SOURCE_C}/%.c, %, $(wildcard ${ANY_DIR_SOURCE_C}/*.c))

I686_COMPILE_C_FLAGS_COMMON = -O0 -std=gnu99 -ffreestanding -Wall
I686_COMPILE_C_FLAGS_INCLUDE = $(addprefix -I , $(wordlist 1, $(words ${I686_DIRS_INCLUDE_C}), ${I686_DIRS_INCLUDE_C}))

I686_COMPILE_C_PATTERN_SOURCE_C = ${ANY_DIR_SOURCE_C}/${name}.c
I686_COMPILE_C_PATTERN_BUILD_C = ${I686_DIR_BUILD_C}/${name}.o

i686-compile-c:
	$(foreach name, ${I686_COMPILE_C_SOURCES_C}, \
	i686-elf-gcc ${I686_COMPILE_C_FLAGS_COMMON} ${I686_COMPILE_C_FLAGS_INCLUDE} -c ${I686_COMPILE_C_PATTERN_SOURCE_C} -o ${I686_COMPILE_C_PATTERN_BUILD_C};)

I686_LINK_FILE_SCRIPT = i686.ld

I686_LINK_FLAGS_COMMON = -nostdlib

I686_LINK_FILES_BUILD_ASM = ${I686_DIR_BUILD_ASM}/bootloader.bin ${I686_DIR_BUILD_ASM}/entrance.bin $(patsubst ${I686_DIR_BUILD_ASM}/entrance.bin,, $(patsubst ${I686_DIR_BUILD_ASM}/bootloader.bin,, $(wildcard ${I686_DIR_BUILD_ASM}/*.bin)))
I686_LINK_FILES_BUILD_C = $(wildcard ${I686_DIR_BUILD_C}/*.o)

I686_LINK_FILE_OUTPUT = ${I686_DIR_BUILD}/bootloader.bin

i686-link: i686-compile-asm i686-compile-c
	i686-elf-gcc -T ${I686_LINK_FILE_SCRIPT} ${I686_LINK_FLAGS_COMMON} ${I686_LINK_FILES_BUILD_ASM} ${I686_LINK_FILES_BUILD_C} -o ${I686_LINK_FILE_OUTPUT}

I686_RELINK_FILE_SCRIPT = ${I686_LINK_FILE_SCRIPT}

I686_RELINK_FLAGS_COMMON = ${I686_LINK_FLAGS_COMMON}

I686_RELINK_FILES_BUILD_ASM = ${I686_LINK_FILES_BUILD_ASM}
I686_RELINK_FILES_BUILD_C = ${I686_LINK_FILES_BUILD_C}

I686_RELINK_FILE_OUTPUT = ${I686_LINK_FILE_OUTPUT}

i686-relink: i686-recompile-asm i686-compile-c
	i686-elf-gcc -T ${I686_RELINK_FILE_SCRIPT} ${I686_RELINK_FLAGS_COMMON} ${I686_RELINK_FILES_BUILD_ASM} ${I686_RELINK_FILES_BUILD_C} -o ${I686_RELINK_FILE_OUTPUT}